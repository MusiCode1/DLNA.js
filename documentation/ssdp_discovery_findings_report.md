# סיכום ממצאים ופיתוח סקריפטים לגילוי התקני SSDP

מסמך זה מסכם את המסקנות העיקריות וההתקדמות בפיתוח סקריפטים לגילוי התקנים ברשת באמצעות פרוטוקול SSDP (Simple Service Discovery Protocol), כחלק מפרוטוקול UPnP.

## 1. הבנת הודעות SSDP

הבנו את ההבדלים המהותיים בין שני סוגי ההודעות העיקריים ב-SSDP:

*   **`NOTIFY`**:
    *   אלו הן הכרזות אסינכרוניות הנשלחות על ידי התקנים.
    *   הן נשלחות בדרך כלל כ-multicast לכתובת `239.255.255.250` ולפורט `1900`.
    *   הודעות `NOTIFY` כוללות `NTS` (Notification Sub-Type) המציין את מהות ההכרזה:
        *   `ssdp:alive`: התקן/שירות זמין ברשת.
        *   `ssdp:byebye`: התקן/שירות עוזב את הרשת.
*   **`M-SEARCH` ותגובות `HTTP/1.1 200 OK`**:
    *   `M-SEARCH` היא בקשת חיפוש הנשלחת על ידי נקודת בקרה (control point) כדי לגלות התקנים או שירותים. גם היא נשלחת בדרך כלל לכתובת ה-multicast `239.255.255.250:1900`.
    *   התקנים התואמים לקריטריוני החיפוש מגיבים עם הודעת `HTTP/1.1 200 OK`.
    *   תגובות אלו נשלחות בדרך כלל כ-unicast בחזרה לכתובת ה-IP והפורט (האקראי, ephemeral) שממנו נשלחה בקשת ה-`M-SEARCH` המקורית.

## 2. חשיבות תצורת ה-Socket להאזנה

כדי לקלוט הודעות `SSDP` באופן אמין, ובמיוחד הודעות `NOTIFY` אסינכרוניות, יש להגדיר את ה-socket כראוי:

*   **קשירה (`bind`) לפורט הנכון**: יש לקשור את ה-socket המאזין לפורט `1900` (הפורט הסטנדרטי של `SSDP`).
*   **האזנה בכל הממשקים**: מומלץ לקשור את ה-socket לכתובת `0.0.0.0` כדי להאזין בכל ממשקי הרשת הזמינים.
*   **הצטרפות לקבוצת Multicast**: יש להשתמש בפקודה `socket.addMembership("239.255.255.250")` כדי שה-socket יקבל הודעות multicast המיועדות לקבוצת `SSDP`.
*   **שימוש ב-`reuseAddr: true`**: אפשרות זו (ב-Node.js, `dgram.createSocket({ type: 'udp4', reuseAddr: true })`) מאפשרת למספר sockets להאזין לאותה כתובת multicast ופורט, דבר חיוני אם יש מספר תהליכים או סקריפטים שמאזינים ל-`SSDP` באותה מכונה.

## 3. פיתוח סקריפטים ובדיקות

### א. סקריפט האזנה פסיבי (`drafts/passive_ssdp_listener.ts`)

*   סקריפט זה נועד אך ורק להאזנה פסיבית להודעות `SSDP` (בעיקר `NOTIFY`, אך גם `M-SEARCH` ממקורות אחרים) בפורט `1900`.
*   הוא הדגים בהצלחה שניתן לקלוט הודעות `NOTIFY` כאשר ה-socket מוגדר כראוי (קשור לפורט `1900` ומצטרף לקבוצת ה-multicast).

### ב. סקריפט גילוי משופר (`drafts/enhanced_ssdp_discoverer.ts`)

סקריפט זה פותח כדי לספק יכולות גילוי מקיפות יותר:

*   **שימוש בשני Sockets**:
    *   `notifySocket`: ייעודי להאזנה פסיבית להודעות `NOTIFY` בפורט `1900`.
    *   `mSearchSocket`: ייעודי לשליחת בקשות `M-SEARCH` (מפורט אקראי) וקבלת תגובות `HTTP/1.1 200 OK` ישירות אליו. הוא גם מצטרף לקבוצת ה-multicast כדי שיוכל לקלוט תגובות `M-SEARCH` שנשלחות כ-multicast, וכן הודעות `NOTIFY` אם הן מגיעות אליו.
*   **קיבוץ מידע לפי התקן פיזי (Device UUID)**:
    *   ה-`USN` (Unique Service Name) מכיל בדרך כלל מזהה התקן פיזי (לפני `::`) ומזהה שירות/תפקיד לוגי (אחרי `::`).
    *   הסקריפט מחלץ את ה-Device UUID מה-`USN` ומשתמש בו כמפתח ראשי לקבץ את כל השירותים וההכרזות השייכים לאותו התקן פיזי.
    *   זה מאפשר לקבל תמונה מאורגנת יותר של ההתקנים ברשת ושירותיהם.
*   **ניהול סטטוס ושמירה לקובץ**:
    *   הסקריפט עוקב אחר סטטוס (`alive`/`byebye`) ברמת השירות/ההכרזה ומספק סטטוס כללי (`_overallStatus`) להתקן הפיזי.
    *   התקנים ששולחים `ssdp:byebye` אינם נמחקים מהרשימה אלא מסומנים ככאלה, כדי לשמור על תיעוד מלא.
    *   בעת סגירת הסקריפט (Ctrl+C), רשימת ההתקנים הפיזיים המקובצת (כולל שירותיהם) נשמרת לקובץ `discovered_devices.json`.
    *   לוגים מפורטים נשמרים לקובץ `enhanced_ssdp_discovery.log`.
*   **רישום הודעות בלתי צפויות**: הסקריפט רושם ללוג הודעות שאינן תואמות את הפורמטים הצפויים של `NOTIFY` או תגובות `M-SEARCH`.

## 4. הבנות נוספות

*   **סדר פעולות אסינכרוני ב-Node.js**: הובהר סדר הפעולות סביב `socket.bind()` ואירוע ה-`'listening'`, והחשיבות של הבנת האסינכרוניות בפיתוח מבוסס אירועים.
*   **התנהגות `USN`**: התקן פיזי אחד יכול להכריז על מספר שירותים או תפקידים לוגיים, ולכן יהיו לו מספר רשומות `USN` שונות, אך כולן יחלקו את אותו Device UUID.

## 5. סטטוס נוכחי

הסקריפט `drafts/enhanced_ssdp_discoverer.ts` נמצא במצב פונקציונלי טוב, קולט ומעבד הודעות `SSDP` משני הסוגים, מקבץ אותן לפי התקן פיזי ושומר את המידע בצורה מובנית. הוא מהווה בסיס טוב להמשך פיתוח וניתוח של התקני UPnP ברשת.