# סיכום חקירת בעיית גילוי התקני SSDP

**תאריך:** 20/05/2025

## 1. הבעיה המקורית
- גילוי התקני SSDP באמצעות סקריפט ה-Node.js הקיים (המשתמש בספריית `node-ssdp`) היה לא עקבי ("עובד פעם כן, פעם לא").
- לעיתים לא נמצאו כלל התקנים, למרות שכלי ייעודי חיצוני ("Windows UPnP Browser") הצליח לגלות התקנים באופן עקבי.

## 2. תהליך האבחון והניסויים
- **הפעלת לוגים מפורטים ב-`node-ssdp`:** לא סיפקה מידע נוסף משמעותי מעבר לכך שהספרייה מנסה להאזין על מספר ממשקי רשת.
- **בדיקת חומת אש:** השבתה זמנית של חומת האש של Windows לא פתרה את הבעיה עבור סקריפט ה-Node.js, מה שהצביע על כך שהבעיה אינה חסימה קבועה של חומת האש.
- **סקריפט פייתון לבדיקה ([`src/python/simple_ssdp_discover.py`](../src/python/simple_ssdp_discover.py:1)):**
    - תחילה, סקריפט פייתון בסיסי (ללא ציון ממשק ספציפי) לא מצא התקנים.
    - לאחר שדרוג הסקריפט כך שיבצע `bind` לממשק ה-WiFi הספציפי של המשתמש (`10.100.102.106`) ויגדיר את `IP_MULTICAST_IF` לאותו ממשק, **הסקריפט הצליח לגלות התקנים באופן עקבי (דרך IPv4).**
- **סקריפט Node.js ברמה נמוכה ([`src/low_level_ssdp_discover.ts`](../src/low_level_ssdp_discover.ts:1)):**
    - נכתב סקריפט Node.js חדש המשתמש במודול `dgram` ללא ספריות SSDP חיצוניות.
    - הסקריפט הורחב לנסות לבצע גילוי על כל ממשקי ה-IPv4 הרלוונטיים, וכן על ממשקי IPv6 Link-Local רלוונטיים.
    - **גילוי על IPv4:** הסקריפט מצליח באופן עקבי ויציב לגלות התקנים דרך ממשק ה-IPv4 של ה-WiFi (`10.100.102.106`), תוך ביצוע `bind` והגדרת `socket.setMulticastInterface()` לממשק זה.
    - **טיפול ב-IPv6:**
        - בוצעו מספר ניסיונות להתאים את הקריאות ל-API של הסוקט (`bind`, `addMembership`, `setMulticastInterface`) עבור IPv6 Link-Local בסביבת Windows, תוך שימוש בפורמט `address%scopeIdNumber` (כאשר `scopeIdNumber` הוא הערך המספרי של ה-Scope ID).
        - הגרסה האחרונה של הסקריפט מצליחה לבצע את פעולות הסוקט הנדרשות ל-IPv6 **ללא שגיאות טכניות בקוד**.
        - עם זאת, **לא התקבלו תגובות SSDP דרך ממשקי ה-IPv6**. ממצא זה, יחד עם המידע מפלט `ipconfig` שהראה היעדר כתובת IPv6 פעילה במתאם ה-WiFi הראשי, מחזק את ההשערה שהיעדר תמיכה/פעילות IPv6 ברשת המקומית של המשתמש (או בהתקני ה-UPnP עצמם) הוא הסיבה לכך.

## 3. מסקנות עיקריות
- **הגורם המרכזי לבעיה הוא ריבוי ממשקי רשת במערכת המשתמש, ובחירה לא נכונה או לא עקבית של ממשק הרשת על ידי ספריית `node-ssdp` (וגם על ידי סקריפטים פשוטים שלא מציינים ממשק).**
- כאשר הודעות ה-M-SEARCH נשלחות דרך ממשק שאינו מגיע להתקני ה-UPnP (למשל, חיבור VPN, ממשק וירטואלי), לא מתקבלות תגובות.
- **הפתרון הוא שליטה מלאה ברמה נמוכה על הסוקט, הכוללת:**
    1.  **קשירה (Bind) של הסוקט לכתובת ה-IP של הממשק הנכון** (במקרה זה, ממשק ה-WiFi `10.100.102.106` עבור IPv4).
    2.  **הגדרה מפורשת של ממשק היציאה להודעות מולטיקאסט** (למשל, `socket.setMulticastInterface()` ב-Node.js).
- האופציה `explicitSocketAddress` בספריית `node-ssdp` לא הספיקה כדי לאכוף התנהגות זו באופן מלא ויציב בסביבת המשתמש.
- **לגבי IPv6:** בעוד שהצלחנו טכנית לבצע את קריאות ה-API של הסוקט ללא שגיאות קוד עבור IPv6 Link-Local (בסביבת Windows, תוך שימוש ב-`address%scopeIdNumber`), היעדר תגובות SSDP על IPv6 מצביע על כך שהבעיה אינה בקוד הגילוי עצמו, אלא ככל הנראה בתשתית הרשת של המשתמש (היעדר תמיכת IPv6 פעילה מהנתב לממשק ה-WiFi, או שהתקני ה-UPnP אינם מאזינים על IPv6).

## 4. המלצה למשימה הבאה
- **פיתוח פונקציית Discovery חדשה ומותאמת אישית ב-Node.js.**
- פונקציה זו תתבסס בעיקר על הלוגיקה המוצלחת של **IPv4** מהסקריפט [`src/low_level_ssdp_discover.ts`](../src/low_level_ssdp_discover.ts:1), אשר סורק את כל ממשקי ה-IPv4 הרלוונטיים.
- יש לשקול אם לכלול את לוגיקת ה-IPv6 בפונקציה הראשית. בהתחשב בכך שאין כרגע תגובות IPv6 ברשת המשתמש, ניתן להשאיר זאת כהרחבה עתידית או כקוד מותנה שאינו מופעל כברירת מחדל. הלוגיקה שפותחה ל-IPv6 בסקריפט הבדיקה יכולה לשמש בסיס אם וכאשר תהיה תמיכת IPv6 רלוונטית.
- הפונקציה צריכה לאפשר גילוי ללא צורך בהגדרת ממשק IP ספציפי מראש על ידי המשתמש (היא תסרוק את כל הממשקים הרלוונטיים).
- **יש ללמוד מהספריות הקיימות (`node-ssdp` ו-`@achingbrain/ssdp`)** כדי לשלב רעיונות טובים ופתרונות לבעיות נפוצות שהן כבר פתרו, כגון:
    - ניתוח מגוון סוגי תגובות SSDP.
    - טיפול בכותרות HTTP.
    - ניהול תקין של מחזור החיים של הסוקט.
    - טיפול בשגיאות רשת.
    - לוגיקה לאחזור וניתוח קובצי התיאור של ההתקנים (XML) והשירותים שלהם.
- המטרה היא ליצור פתרון גילוי SSDP אמין, יציב, וניתן להתאמה אישית עבור הפרויקט.

## 5. קבצים רלוונטיים מהחקירה הנוכחית
- סקריפט פייתון מוצלח: [`src/python/simple_ssdp_discover.py`](../src/python/simple_ssdp_discover.py:1)
- סקריפט Node.js מוצלח ברמה נמוכה: [`src/low_level_ssdp_discover.ts`](../src/low_level_ssdp_discover.ts:1)
## 6. הצעה למשימה הבאה - פיתוח פונקציית Discovery מותאמת אישית

**תיאור המשימה:**

ברצוננו לפתח פונקציית Discovery חדשה ומותאמת אישית ב-Node.js לגילוי התקני SSDP.
הפונקציה צריכה להתבסס על הלוגיקה המוצלחת של הסקריפט שפיתחנו ב-[`src/low_level_ssdp_discover.ts`](../src/low_level_ssdp_discover.ts:1), אשר משתמש במודול `dgram` ומבצע bind לממשק רשת ספציפי.
יש להתייחס לממשק ה-WiFi עם הכתובת `10.100.102.106` כברירת מחדל או כדוגמה לממשק ספציפי שדרכו יש לבצע את החיפוש.

בנוסף, חשוב ללמוד מהספריות הקיימות בפרויקט (`node-ssdp` ו-`@achingbrain/ssdp`) כדי לשלב רעיונות טובים ופתרונות לבעיות נפוצות שהן כבר פתרו, כגון:
- ניתוח מגוון סוגי תגובות SSDP.
- טיפול בכותרות HTTP.
- ניהול תקין של מחזור החיים של הסוקט.
- טיפול בשגיאות רשת.
- אחזור פרטי התקנים מקובצי XML (תיאור התקן ושירותים).

המטרה היא ליצור פתרון גילוי SSDP אמין ויציב שיחליף את השימוש הנוכחי בספריית `node-ssdp` בקבצים [`src/discovery.ts`](../src/discovery.ts:1) ו-[`src/runDiscovery.ts`](../src/runDiscovery.ts:1).