# תוכנית: שילוב Wake-on-LAN עם בדיקות פינג ב־proxy-server

## מטרות
- לחשוף ממשק API ב־`packages/proxy-server/src/index.ts` שמעדיר טלוויזיה באמצעות מודול WOL הקיים (`packages/wake-on-lan`) ומוודא זמינות בעזרת פינג.
- להוסיף ב־UI (`packages/proxy-server/public/index.html`, `packages/proxy-server/public/client.ts`) זרימה המאפשרת למשתמש להפעיל טלוויזיה כבויה, לקבל חיווי סטטוס, ולשמור כתובת MAC עבור חיבור ידני או רשימת טלוויזיות.
- לשמור על מבנה הפרויקט הקיים ולספק לוגים והודעות שגיאה ברורות בעברית עבור המשתמש.

## תלות מקדימה
- הכללת החבילה `wake-on-lan` כ־dependency של `proxy-server` (העדפה: `workspace:*` ב־`packages/proxy-server/package.json`).
- ודא התקנת `ping` ו־`@types/ping` באם לא קיימים ב־monorepo (כבר בשימוש מודול ה־WOL; אין לשכפל לוגיקה).
- ריענון build client-side (`bun run build:client`) לאחר שינויים ב־`client.ts`.

## שלבי מימוש

### 1. הרחבת backend
1. לייבא מ־`packages/wake-on-lan` את `wakeDeviceAndVerify` (ייתכן גם `checkPing`/`checkPingWithRetries` לעתיד).
2. להוסיף ב־`packages/proxy-server/src/index.ts` נתיב `POST /api/wake`:
   - לקבל JSON עם `ipAddress`, `macAddress`, ופרמטרים אופציונליים (`broadcast`, `wolPort`, `pingTimeoutSeconds`, `pingIntervalSeconds`).
   - לבצע ולידציה בסיסית (פורמט IP, אורך MAC, ערכי timeout).
   - לזמן `wakeDeviceAndVerify` בתוך `try/catch`; להחזיר:
     ```json
     { "status": "awake", "details": { ...פרמטרים..., "pingAttempts": מספר } }
     ```
     או הודעת כשל עם קוד 500/400 והסבר בעברית.
   - להוסיף תיעוד לוגים (`console.log`/`console.error`) עם מזהה בקשה (timestamp או counter) כדי להקל על דיבוג מרובה בקשות.
3. לטפל בזמני תגובה:
   - שימוש ב־`AbortController` או timeout פנימי (Promise.race) על `wakeDeviceAndVerify` כדי למנוע בקשות שתלויות לנצח.
   - להחזיר 504 במקרה של timeout תוך ניקוי לוגים.

### 2. עדכון client
1. UI:
   - ב־`packages/proxy-server/public/index.html` להוסיף כפתור בסקשן בחירת הטלוויזיה (בתוך כרטיסת רשימת הטלוויזיות) וכפתור נוסף במקטע ההזנה הידנית. הכפתור מציג טקסט כמו “הפעל מסך (WoL)”.
   - להציג אינדיקציה (spinner או טקסט) בזמן שהבקשה נשלחת. שימוש ב־CSS קיים ככל האפשר.
2. לוגיקה ב־`client.ts`:
   - להוסיף פונקציית `async wakeSelectedTv()` שמזהה IP ו־MAC מתוך הבחירה או השדות הידניים (כולל שמירה ב־localStorage).
   - השליחה ל־`/api/wake` תעשה באמצעות `fetch` עם `POST` ו־`Content-Type: application/json`.
   - ניהול סטטוסים:
     - עדכון `statusDiv` ל״מפעיל את הטלוויזיה…״ בזמן הבקשה.
     - במקרה הצלחה, לסטטוס ירוק (למשל `status awake`) ולהציע להתחבר.
     - במקרה כשל, להציג הודעה אדומה עם הסבר (תוכן ההודעה משרת).
   - טיפול בשגיאות רשת (catch) עם הודעה ידידותית.
3. תמיכה בחיבור ידני:
   - להוסיף שדה חדש לכתובת MAC בקטע הידני (HTML + binding ב־JS).
   - להרחיב את `saveSettings()` כך שיאחסן MAC (ידני והנבחר מהרשימה).
   - בעת בחירת טלוויזיה מהרשימה, למשוך MAC מהרשימה ולעדכן את השדה הידני וה־DOM (display).

### 3. סינכרון עם זרימת חיבור קיימת
- לאחר הצלחה בהפעלת WOL, ניתן לקרוא אוטומטית לפונקציית `connect()` או להאיר את כפתור החיבור (החלטה בהתאם לחוויית משתמש רצויה).
- להבטיח שהמצבים `continuousScreenshotInterval` ו־חיבורים אחרים מתאפסים אם ה־TV עדיין לא זמין (למשל, לא לקרוא ל־`connect()` לפני שהמשתמש מוכן).
- לעדכן את הטקסט בקבצי UI כך שהמשתמש יבין שצריך לאשר את התעודה מחדש אם הטלוויזיה אתחלה.

### 4. לוגים ותיעוד
- להוסיף קטע ב־`packages/proxy-server/README.md` שמסביר איך להפעיל את השרת ואת נתיב `/api/wake`.
- אם נדרש CI/בדיקות אוטומטיות, ליצור “dry run” המתבצע כאשר `process.env.WOL_DRY_RUN === '1'` (הפונקציה מחזירה הצלחה מיידית ללא שליחה).

## בדיקות מוצעות
1. **בדיקת קצה חיובית**: טלוויזיה כבויה → לחיצה על “הפעל מסך” → וידוא שהתגובה `awake` ושניתן להתחבר.
2. **כתובת MAC שגויה**: לוודא שמתקבלת תגובת 500/400 עם הודעה מובנת, ללא קריסה בצד השרת.
3. **חיבור ידני ללא MAC**: וידוא שהמערכת מונעת שליחה ומציגה ולידציה.
4. **Timeout רשת**: ניתוק מה־LAN/הדממה → וידוא שמתקבלת תגובת timeout ולאחר מכן שהמערכת חוזרת למצב תקין.
5. **Regression**: חיבור WebSocket רגיל ופקודות קיימות ממשיכות לפעול לאחר התוספת.

## סיכונים ופתרונות
- **כישלונות פינג ברשתות שונות**: לאפשר התאמת timeout/interval דרך UI מתקדמת או קובץ קונפיג (עתידי).
- **הרשאות Broadcast**: לוודא שהשרת רץ עם ההרשאות לשליחת broadcast (`client.setBroadcast(true)` כבר מטופל במודול).
- **סרגל הקשיחות של הדפדפן**: להבטיח שקריאת `fetch` מטפלת בשגיאות CORS, במיוחד בסביבה Production (חלק מ־proxy-server ולכן אין קושי).

## משימות המשך (אופציונלי)
- אוטומציה של זיהוי MAC מהרשת (ARP table) כאשר המשתמש מזין רק IP.
- הוספת היסטוריית הפעלות / לוגים ב־UI לצורך דיבוג.
- תמיכה ב־Wake-on-LAN מרובה לטלוויזיה אחת (למשל, ניסיונות רבים עם Broadcastים שונים).

